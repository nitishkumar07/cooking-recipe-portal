pipeline {
    agent any

    environment {
        REPO = "nitishkumar07/cooking-recipe-portal"
        FRONTEND_PATH = "app"
        BACKEND_PATH  = "server"
        FRONTEND_IMAGE = "nitishkumar7/recipes_frontend"
        BACKEND_IMAGE  = "nitishkumar7/recipes_backend"
        DOCKERHUB_USER = "nitishkumar7"
    }

    stages {

        /* ------------ CHECKOUT CODE ------------ */
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: "https://github.com/${REPO}.git",
                    credentialsId: 'jenkins-github'
            }
        }

        /* ------------ LOGIN TO DOCKER HUB ------------ */
        stage("Login to DockerHub") {
            steps {
                withCredentials([string(
                    credentialsId: 'Dockerhub-jenkins',
                    variable: 'DH_TOKEN'
                )]) {
                    sh '''
                        echo "$DH_TOKEN" | docker login -u "${DOCKERHUB_USER}" --password-stdin
                    '''
                }
            }
        }

        /* ------------ DETECT CHANGES ------------ */
        stage('Detect Changes') {
            steps {
                script {
                    // Detect frontend changes
                    def frontend_diff = sh(
                        script: "git diff --name-only HEAD~1 HEAD | grep '^${FRONTEND_PATH}/' || true",
                        returnStdout: true
                    ).trim()

                    // Detect backend changes
                    def backend_diff = sh(
                        script: "git diff --name-only HEAD~1 HEAD | grep '^${BACKEND_PATH}/' || true",
                        returnStdout: true
                    ).trim()

                    // Set environment variables for cross-stage usage
                    env.FRONTEND_CHANGED = (frontend_diff != '' ? 'true' : 'false')
                    env.BACKEND_CHANGED  = (backend_diff != '' ? 'true' : 'false')

                    echo "Frontend changed: ${env.FRONTEND_CHANGED}"
                    echo "Backend changed: ${env.BACKEND_CHANGED}"
                }
            }
        }

        /* ------------ FRONTEND PIPELINE ------------ */
        stage('SonarQube Analysis (Frontend + Backend)') {
            steps {
                script {
                    withSonarQubeEnv('SonarQube') {
                       sh """
                           sonar-scanner \
                             -Dsonar.projectKey=recipies \
                             -Dsonar.projectName=recipies \
                             -Dsonar.sources=app,server \
                             -Dsonar.login=$SONAR_TOKEN \
                             -Dsonar.host.url=$SONAR_HOST_URL
                       """
                   }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Build Frontend Image') {
            when { expression { env.FRONTEND_CHANGED == 'true' } }
            steps {
                sh "docker build -t ${FRONTEND_IMAGE}:${BUILD_NUMBER} ${FRONTEND_PATH}"
            }
        }

        stage('Trivy Scan - Frontend') {
            when { expression { env.FRONTEND_CHANGED == 'true' } }
            steps {
                sh """
                    echo "Running Trivy scan for Frontend image..."
                    trivy image --exit-code 1 --severity CRITICAL ${FRONTEND_IMAGE}:${BUILD_NUMBER}
                """
            }
        }

        stage('Push Frontend Image') {
            when { expression { env.FRONTEND_CHANGED == 'true' } }
            steps {
                sh "docker push ${FRONTEND_IMAGE}:${BUILD_NUMBER}"
            }
        }

        /* ------------ BACKEND PIPELINE ------------ */

        stage('Build Backend Image') {
            when { expression { env.BACKEND_CHANGED == 'true' } }
            steps {
                sh "docker build -t ${BACKEND_IMAGE}:${BUILD_NUMBER} ${BACKEND_PATH}"
            }
        }

        stage('Trivy Scan - Backend') {
            when { expression { env.BACKEND_CHANGED == 'true' } }
            steps {
                sh """
                    echo "Running Trivy scan for Backend image..."
                    trivy image --exit-code 1 --severity CRITICAL ${BACKEND_IMAGE}:${BUILD_NUMBER}
                """
            }
        }

        stage('Push Backend Image') {
            when { expression { env.BACKEND_CHANGED == 'true' } }
            steps {
                sh "docker push ${BACKEND_IMAGE}:${BUILD_NUMBER}"
            }
        }
    }

    post {
        always {
            sh "docker logout"
        }
    }
}
